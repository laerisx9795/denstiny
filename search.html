<html>
	<head>
		<link href="css/bootstrap.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="style.css" />
		<link rel="stylesheet" type="text/css" href="date.css" />
		<script type="text/javascript" src="js/jquery-3.1.1.min.js"></script>
		<link href="https://fonts.googleapis.com/css?family=Abril+Fatface" rel="stylesheet">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<meta charset="UTF-8">
		<script src="datedropper.min.js"></script>
		<script src="timedropper.min.js"></script>
		<script src="js/main.js"></script>
		<script src="js/fdb-all.min.js"></script>
		<title>Score Recorder</title>
	</head>
	<body>
		<h2>Search</h2>
		<h4>Subject:</h4>
		<input type="text" class="inputs" id="subjectName"/>
		<h4>Test Date:</h4>
		<div>
			<label><h4><input type="radio" name="time" id="thisMonth"/>本月</h4></label><br>
			<label><h4><input type="radio" name="time" id="period"/>指定期間</h4></label><br>
			<input type="text" class="inputs" id="pickdate1" readonly="readonly"/><h4>～</h4><input type="text" class="inputs" id="pickdate2" readonly="readonly"/>
		</div>
		<h4>Type:</h4>
		<input type="text" class="inputs" id="type"/><br><br>
		<button class="buttons" id="search">Search</button><br><br>
		<table  style="border:3px #FFD382 dashed;">
			<thead>
				<tr>
					<td>Subject</td>
					<td>Test Date</td>
					<td>Type</td>
					<td>Score</td>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
		<table>
			<thead>
				<tr>
					<td>Subject</td>
					<td>Score</td>
					<td>Percent</td>
				</tr>
			</thead>
			<tbody id="scorePercent">
			</tbody>
		</table>
		<br><br><br><br>
		<button class="buttons" id="home"><a href="index.html">Go Back to Home</a></button>  
		<script>
			$("#pickdate1").dateDropper({
				animate: false,
				format: 'Y-m-d',
				maxYear: '2020'
			});
			$("#pickdate2").dateDropper({
				animate: false,
				format: 'Y-m-d',
				maxYear: '2020'
			});
			var fdb = new ForerunnerDB();
			var db = fdb.db("SR");
			var scoreCollection = db.collection('score');
			scoreCollection.load();
			$("table").hide();
			function scoreSearchDate(){
				$("tbody").text("");
				$("table").show();
				var sum=[0,0,0,0,0,0,0];
				var subject=["國文","英文","數學","電子學","基本電學","基本電學實習","數位邏輯"];
				var totalScore =0;
				var query;
				if($("input#thisMonth:checked").length != 0 && $("input#period:checked").length == 0){
					var date = new Date();
					var month = date.getMonth()+1;
					var nextMonth = month+1;
					var year = date.getFullYear();
					if(month < 10)
						month = "0"+month;
					if(nextMonth < 10)
						nextMonth = "0"+nextMonth;
					query={
						Date: {
							"$gte":year+"-"+month+"-0"+1 ,
							"$lt":year+"-"+nextMonth+"-0"+1
						}
					};//query
					for(var i=0;i<scoreCollection.find(query).length;i++){
						var score = "<tr><td>"+scoreCollection.find(query)[i].Subject+"</td><td>"+scoreCollection.find(query)[i].Date+"</td><td>"+scoreCollection.find(query)[i].Type+"</td><td>"+scoreCollection.find(query)[i].Score+"</td></tr>";
						$("tbody").append(score);
						switch(scoreCollection.find(query)[i].Subject){
							case "國文" :
								this.sum[0] += scoreCollection.find(query)[i].Score/1;
								break;
							case "英文" :
								this.sum[1] += scoreCollection.find(query)[i].Score/1;
								break;
							case "數學" :
								this.sum[2] += scoreCollection.find(query)[i].Score/1;
								break;
							case "電子學" :
								this.sum[3] += scoreCollection.find(query)[i].Score/1;
								break;
							case "基本電學" :
								this.sum[4] += scoreCollection.find(query)[i].Score/1;
								break;
							case "基本電學實習" :
								this.sum[5] += scoreCollection.find(query)[i].Score/1;
								break;
							default :
								this.sum[6] += scoreCollection.find(query)[i].Score/1;
								break;
											     }//switch
						totalScore += scoreCollection.find(query)[i].Score/1;
					}//for
					for(var i =0;i<sum.length;i++){
						var percent = "<tr><td>"+subject[i]+"</td><td>"+sum[i]+"</td><td>"+Math.floor((sum[i]/totalScore)*100)+"%</td></tr>";
						$("tbody#scorePercent").append(percent);
					}//for
				}
				if($("input#thisMonth:checked").length == 0 && $("input#period:checked").length != 0){
					var query1={
						Date: {
							"$gte": $("#pickdate1").val() ,
							"$lte": $("#pickdate2").val()
						}
					};//query
					var query2={
						 $orderBy: {date: -1}
					};//queryvar
					result=scoreCollection.find(query1,query2);
					for(var i=0;i<scoreCollection.find(result).length;i++){
						var score = "<tr><td>"+scoreCollection.find(result)[i].Subject+"</td><td>"+scoreCollection.find(result)[i].Date+"</td><td>"+scoreCollection.find(result)[i].Type+"</td><td>"+scoreCollection.find(result)[i].Score+"</td></tr>";
						$("tbody").append(score);
						switch(scoreCollection.find(result)[i].Subject){
							case "國文" :
								this.sum[0] += scoreCollection.find(result)[i].Score/1;
								break;
							case "英文" :
								this.sum[1] += scoreCollection.find(result)[i].Score/1;
								break;
							case "數學" :
								this.sum[2] += scoreCollection.find(result)[i].Score/1;
								break;
							case "電子學" :
								this.sum[3] += scoreCollection.find(result)[i].Score/1;
								break;
							case "基本電學" :
								this.sum[4] += scoreCollection.find(result)[i].Score/1;
								break;
							case "基本電學實習" :
								this.sum[5] += scoreCollection.find(result)[i].Score/1;
								break;
							default :
								this.sum[6] += scoreCollection.find(result)[i].Score/1;
								break;
											     }//switch
						totalScore += scoreCollection.find(result)[i].Score/1;
					}//for
			for(var i =0;i<sum.length;i++){
				var percent = "<tr><td>"+subject[i]+"</td><td>"+sum[i]+"</td><td>"+Math.floor((sum[i]/totalScore)*100)+"%</td></tr>";
				$("tbody#scorePercent").append(percent);
			}//for
			}else{
				var query2={
						 $orderBy: {date: -1}
				};//queryvar
				for(var i=0;i<scoreCollection.find(query2).length;i++){
					var score = "<tr><td>"+scoreCollection.find(query2)[i].Subject+"</td><td>"+scoreCollection.find(query2)[i].Date+"</td><td>"+scoreCollection.find(query2)[i].Type+"</td><td>"+scoreCollection.find(query2)[i].Score+"</td></tr>";
					$("tbody").append(score);
					switch(scoreCollection.find(query2)[i].Subject){
						case "國文" :
							this.sum[0] += scoreCollection.find(query2)[i].Score/1;
							break;
						case "英文" :
							this.sum[1] += scoreCollection.find(query2)[i].Score/1;
							break;
						case "數學" :
							this.sum[2] += scoreCollection.find(query2)[i].Score/1;
							break;
						case "電子學" :
							this.sum[3] += scoreCollection.find(query2)[i].Score/1;
							break;
						case "基本電學" :
							this.sum[4] += scoreCollection.find(query2)[i].Score/1;
							break;
						case "基本電學實習" :
							this.sum[5] += scoreCollection.find(query2)[i].Score/1;
							break;
						default :
							this.sum[6] += scoreCollection.find(query2)[i].Score/1;
							break;
										     }//switch
					totalScore += scoreCollection.find(query2)[i].Score/1;
				}//for
				for(var i =0;i<sum.length;i++){
					var percent = "<tr><td>"+subject[i]+"</td><td>"+sum[i]+"</td><td>"+Math.floor((sum[i]/totalScore)*100)+"%</td></tr>";
					$("tbody#scorePercent").append(percent);
				}
			}
			}//function
			$("#search").on("click", scoreSearchDate);
		</script>
	</body>
</html>
